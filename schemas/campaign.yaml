# JSON schema for MediaUploader campaigns
#
# Changes to this schema MUST be backwards-compatible.
# See tests/phpunit/unit/Campaign/ValidatorTest.php for schema tests

$schema: 'http://json-schema.org/draft-04/schema#'

################################
## Definitions used elsewhere ##
################################
definitions:
  # Represents a name of a license defined in the global config
  licenseName:
    type: string
    # To be filled by PHP code during execution
    # PHP snippet: $schema->definitions->licenseName->enum = ...
    enum: [ ~ ]

  # 'defaults' field in licensing config
  defaultLicensesField:
    oneOf:
      - { $ref: '#/definitions/licenseName' }
      - type: array
        items: { $ref: '#/definitions/licenseName' }

  # The "display" section of the config
  displaySection:
    type: object
    additionalProperties: false
    properties:
      headerLabel: { type: string }
      thanksLabel: { type: string }
      homeButton:
        type: object
        additionalProperties: false
        properties:
          label: { type: string }
          target: { type: string }
      beginButton:
        type: object
        additionalProperties: false
        properties:
          label: { type: string }
          target: { type: string }

  # The "autoAdd" section of the config
  autoAddSection:
    type: object
    additionalProperties: false
    properties:
      categories:
        type: array
        items: { type: string }
      wikitext: { type: string }

  # Base for fields in the details step
  fieldBase:
    type: object
    properties:
      # Not defined here:
      #  - type: it's defined as enum in each field type
      #  - default: has a different datatype in each field type
      type: { type: string }
      order: { type: integer }
      label: { type: string }
      help: { type: string }
      required:
        type: string
        enum:
          - required
          - recommended
          - optional
      hidden: { type: boolean }
      enabled: { type: boolean }
      auxiliary: { type: boolean }
    required:
      - order
      - label
      - type

  fieldText:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              - text
              # Multiline input
              - textarea
              # Title field is very similar
              # We could separate it for more validation, but meh
              - title
          default: { type: string }
          minLength: { type: integer }
          maxLength: { type: integer }
          autoFill:
            type: boolean
          # Acknowledge the fieldBase properties so that we can disallow
          # additional properties.
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

  fieldSingleLang:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              # textarea + language choice
              - singlelang
          default:
            type: object
            properties:
              language: { type: string }
              text: { type: string }
            required:
              - language
              - text
          minLength: { type: integer }
          maxLength: { type: integer }
          autoFill:
            type: boolean
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

  fieldMultiLang:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              # Multi textarea + language choice
              - multilang
          default:
            type: array
            items:
              type: object
              properties:
                language: { type: string }
                text: { type: string }
              required:
                - language
                - text
          minLength: { type: integer }
          maxLength: { type: integer }
          autoFill:
            type: boolean
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

  fieldSelect:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          # JSON Schema Draft 4 does not support const values, so just use an enum
          type:
            enum:
              - select
          default: { type: string }
          options:
            type: object
            additionalProperties: { type: string }
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false
        required:
          - options

  fieldDate:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              - date
          default: { type: string }
          autoFill:
            type: boolean
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

  fieldCategories:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              - categories
          default:
            type: array
            items: { type: string }
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

  fieldLocation:
    allOf:
      - $ref: '#/definitions/fieldBase'
      - type: object
        properties:
          type:
            enum:
              - location
          fields:
            type: array
            items:
              type: string
              uniqueItems: true
              enum:
                - latitude
                - longitude
                - heading
                - altitude
          default:
            type: object
            properties:
              latitude:
                type: number
                minimum: -90
                maximum: 90
              longitude:
                type: number
                minimum: -180
                maximum: 180
              heading:
                type: number
                minimum: 0
                maximum: 360
              altitude:
                type: string
          autoFill:
            type: boolean
          # # # # #
          order: { }
          label: { }
          help: { }
          required: { }
          hidden: { }
          enabled: { }
          auxiliary: { }
        additionalProperties: false

################################
#### The main config object ####
################################
type: object
additionalProperties: false
properties:
  # General campaign properties
  title: { type: string }
  description: { type: string }
  enabled: { type: boolean }
  start: { type: string }
  end: { type: string }

  # Automatically added items
  autoAdd: { $ref: '#/definitions/autoAddSection' }

  # Field definitions
  fields:
    type: object
    additionalProperties:
      oneOf:
        # null can be used for "unsetting" fields previously defined in the main config
        - type: 'null'
        - $ref: '#/definitions/fieldText'
        - $ref: '#/definitions/fieldSingleLang'
        - $ref: '#/definitions/fieldMultiLang'
        - $ref: '#/definitions/fieldSelect'
        - $ref: '#/definitions/fieldDate'
        - $ref: '#/definitions/fieldCategories'
        - $ref: '#/definitions/fieldLocation'

  # Field -> content (wikitext) transformation
  content:
    type: object
    properties:
      titleField: { type: string }
      captionField: { type: string }

  # Labels and URLs on things
  display: { $ref: '#/definitions/displaySection' }

  # License groups
  licensing:
    type: object
    additionalProperties: false
    properties:
      defaultType: { type: string }
      ownWorkDefault: { type: string }

      # TODO: This is all wrong. ownWork should allow for license groups
      # Resolve this in T278871
      # Refactor common code from these two and make it readable
      ownWork:
        type: object
        additionalProperties: false
        properties:
          defaults: { $ref: '#/definitions/defaultLicensesField' }
          licenses:
            type: array
            items: { $ref: '#/definitions/licenseName' }
          template: { type: string }
          type: { type: string }

      # TODO: thirdParty should allow for licenses without groups
      thirdParty:
        type: object
        additionalProperties: false
        properties:
          defaults: { $ref: '#/definitions/defaultLicensesField' }
          licenseGroups:
            type: array
            items:
              type: object
              additionalProperties: false
              properties:
                head: { type: string }
                licenses:
                  type: array
                  items: { $ref: '#/definitions/licenseName' }
                subhead: { type: string }
          type: { type: string }

  # The tutorial
  tutorial:
    type: object
    additionalProperties: false
    properties:
      enabled: { type: boolean }
      skip: { type: boolean }
      wikitext: { type: string }

  # (before|while|after)Active modifiers
  beforeActive:
    type: object
    additionalProperties: false
    properties:
      display: { $ref: '#/definitions/displaySection' }

  whileActive:
    type: object
    additionalProperties: false
    properties:
      display: { $ref: '#/definitions/displaySection' }
      autoAdd: { $ref: '#/definitions/autoAddSection' }

  afterActive:
    type: object
    additionalProperties: false
    properties:
      display: { $ref: '#/definitions/displaySection' }

required:
  - enabled
